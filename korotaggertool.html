<!DOCTYPE html>
<html>

<head>
    <title>Korotagger tool</title>
    <script src="historymanager.js"></script>
    <script src="util.js"></script>
    <style>
        .row {
            display: flex;
        }

        .column {
            flex: 50%;
        }

        .tagslist {
            overflow: auto;
            height: 500px;
        }

        #output {
            overflow: scroll;
        }
    </style>
</head>

<body>
    <div class="row">
        <div class="column">
            <button id="convert">Load from !tags</button>
            <input type="radio" id="ktradio" name="inputtype" value="Korotagger" checked>
            <label for="ktradio">Korotagger</label>
            <input type="radio" id="ytradio" name="inputtype" value="YTComment">
            <label for="ytradio">YT Comment</label>
            <textarea id="input" rows="5" cols="50" placeholder="Tags to load go here"></textarea>

            <div id="undoredocontainer">
                <button id="undobutton">Undo</button>
                <button id="redobutton">Redo</button>
            </div>
            <button id="addbutton">Add New</button>
            <div id="taglist">
                <h1>JavaScript is required.</h1>
            </div>
        </div>
        <div class="column">
            <div id="player"></div>
            <form action="#" id="videoinputform">
                <input id="videoinput" value="https://www.youtube.com/watch?v=jNQXAC9IVRw" size="40" />
                <button id="videoinputsubmit" type="submit">Load Video</button>
            </form>
            <form action="#" id="videotimeform">
                <button id="backonesecond">-1s</button>
                <input id="timedisplay" value="0:00" />
                <button id="forwardonesecond">+1s</button>
                <button id="videotimesubmit" type="submit">Jump to Time</button>
            </form>
            <textarea id="output" rows="20" cols="80" placeholder="Output appears here..."></textarea>
            <input id="filenameinput" value="tags.txt">
            <button id="downloadbutton" onclick="download()">Save to disk</button>
            <span id="status">Status OK</span>
        </div>
    </div>


    <script src="listrenderer.js"></script>
    <script>
        document.addEventListener("keydown", (e) => {
            // console.log((e.ctrlKey || e.metaKey), e.shiftKey, e.key);
            if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key == 'z') {
                redo();
                e.preventDefault();
            } else if ((e.ctrlKey || e.metaKey) && e.key == 'z') {
                undo();
                e.preventDefault();
            } else if ((e.ctrlKey || e.metaKey) && e.key == 's') {
                download();
                e.preventDefault();
            }/*else if ((e.ctrlKey || e.metaKey) && e.key == 'y') {
                redo();
                e.preventDefault();
            }*/
        });
        const convert_button = document.getElementById("convert");
        const kt_radio = document.getElementById("ktradio");
        const yt_radio = document.getElementById("ytradio");
        const addbutton = document.getElementById("addbutton");
        const input_textarea = document.getElementById("input");
        const output_textarea = document.getElementById("output");
        const videoid_input = document.getElementById("videoinput");
        const videoidinput_form = document.getElementById("videoinputform");
        const timedisplay = document.getElementById("timedisplay");
        const videotime_form = document.getElementById("videotimeform");
        const backonesecond = document.getElementById("backonesecond");
        const forwardonesecond = document.getElementById("forwardonesecond");
        const taglist = document.getElementById("taglist");
        const undobutton = document.getElementById("undobutton");
        const redobutton = document.getElementById("redobutton");
        const filename_input = document.getElementById("filenameinput");
        const status_span = document.getElementById("status");

        let player;
        let tagsJson = loadTagsFromStorage();

        if (tagsJson === null) {
            // Initalize tag list to have 1 item to make it look good
            tagsJson = [];
            addNewTag();
        } else {
            console.log(tagsJson);
            newHistory(tagsJson);
            renderTagList();
            const videoid = getIdFromUrl(tagsJson[0].text);
            if (videoid !== null) {
                videoid_input.value = "https://youtube.com/watch?v=" + videoid;
            }
        }

        convert_button.onclick = ev => {
            if (yt_radio.checked) {
                tagsJson = parseTags(input_textarea.value, parseSingleTagYTCommentTag);
            } else {
                tagsJson = parseTags(input_textarea.value);
            }
            loadVideoFromTags(tagsJson);
            newHistory(tagsJson);
            renderTagList();
            const output = renderPreferred(tagsJson);
            output_textarea.value = output;
        };

        addbutton.onclick = addNewTag;

        videoidinput_form.onsubmit = ev => {
            loadVideoFromUrl(videoid_input.value);
            ev.preventDefault();
        }

        videotime_form.onsubmit = ev => {
            const seconds = smartTimestampToSeconds(timedisplay.value);
            if (isNaN(seconds)) {
                // timedisplay.value = "Invalid timestamp.";
                updateVideoTimeDisplay();
                ev.preventDefault();
                return false;
            }
            player.seekTo(seconds, true);
            ev.preventDefault();
        }

        backonesecond.onclick = ev => {
            let newtime = getVideoTime() - 1;
            if (newtime < 0) {
                newtime = 0;
            }
            timedisplay.value = secondsToTimestamp(newtime);
            player.seekTo(newtime, true);
        }

        forwardonesecond.onclick = ev => {
            let newtime = getVideoTime() + 1;
            timedisplay.value = secondsToTimestamp(newtime);
            player.seekTo(newtime, true);
        }

        undobutton.onclick = undo;

        redobutton.onclick = redo;

        // 2. This code loads the IFrame Player API code asynchronously.
        const tag = document.createElement('script');

        tag.src = "https://www.youtube.com/iframe_api";
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        // 3. This function creates an <iframe> (and YouTube player)
        //    after the API code downloads.
        function onYouTubeIframeAPIReady() {

            player = new YT.Player('player', {
                height: '390',
                width: '640',
                videoId: getIdFromUrl(videoid_input.value),
                playerVars: {
                    'playsinline': 1
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        // 4. The API will call this function when the video player is ready.
        function onPlayerReady(event) {
            updateVideoTimeDisplay();
            event.target.stopVideo();
        }

        // 5. The API calls this function when the player's state changes.
        //    The function indicates that when playing a video (state=1),
        //    the player should update the timestamp every second.
        let secondsUpdateInterval = null;
        function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.PLAYING && !secondsUpdateInterval) {
                secondsUpdateInterval = setInterval(updateVideoTimeDisplay, 10);
            } else {
                if (secondsUpdateInterval) {
                    clearInterval(secondsUpdateInterval);
                    secondsUpdateInterval = null;
                }
            }
        }

        function loadVideoFromTags(tags) {
            if (tags.length > 0 && tags[0].time === null || isNaN(tags[0].time)) {
                // Attempt to load a video
                const videoId = getIdFromUrl(tags[0].text);
                if (videoId !== null) {
                    loadVideo(videoId);
                }
            }
        }

        function loadVideoFromUrl(url) {
            loadVideo(getIdFromUrl(url));
        }

        function loadVideo(id) {
            player.loadVideoById(id);
            player.stopVideo();
        }

        function stopVideo() {
            player.stopVideo();
        }

        function getVideoTime() {
            return Math.floor(player.getCurrentTime());
        }

        function updateVideoTimeDisplay() {
            timedisplay.value = secondsToTimestamp(getVideoTime());
        }

        function updateTagsWithHistory(newTagJson) {
            addToHistory(newTagJson);
            tagsJson = newTagJson;
        }

        function renderTagList() {
            const tags = renderTags(tagsJson, (t) => {
                updateTagsWithHistory(t);
                renderTagList();
                const output = renderPreferred(tagsJson);
                output_textarea.value = output;
            }, (time) => player.seekTo(time));
            taglist.innerHTML = "";
            taglist.appendChild(tags);
        }

        function addNewTag() {
            tagsJson.unshift({
                "text": "",
                "time": null
            })
            addToHistory(tagsJson);
            renderTagList();
        }

        function undo() {
            const newstate = goBackInHistory();
            if (newstate !== null) {
                tagsJson = newstate;
                renderTagList();
                const output = renderPreferred(tagsJson);
                output_textarea.value = output;
            }
        }

        function redo() {
            const newstate = goForwardInHistory();
            if (newstate !== null) {
                tagsJson = newstate;
                renderTagList();
                const output = renderPreferred(tagsJson);
                output_textarea.value = output;
            }
        }

        function download() {
            const output = output_textarea.value;
            // console.log("Trying to dl");
            var element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(output));
            element.setAttribute('download', filename_input.value);

            element.style.display = 'none';
            document.body.appendChild(element);

            element.click();

            document.body.removeChild(element);
        }

        function autoSave() {
            status_span.innerText = "Last saved on " + new Date().toISOString();
            saveTagsToStorage(tagsJson);
        }

        const autosaveInterval = setInterval(autoSave, 5000);
    </script>
</body>

</html>